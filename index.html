<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Existing head content -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>üìù Sentence Types Quiz</h1>
        
        <div id="loginSection">
            <div class="student-info">
                <label for="canteenCode" style="display: block; margin-bottom: 8px; font-weight: bold;">Canteen Code:</label>
                <input 
                    type="text" 
                    id="canteenCode" 
                    placeholder="Enter your 6-digit Canteen Code" 
                    pattern="[0-9]{6}" 
                    maxlength="6" 
                    required 
                    style="user-select: text;"
                >
                <small style="color: #666; display: block; margin-top: 5px;">
                    Your 6-digit Canteen Code can be found on your school ID
                </small>
            </div>
            
            <div id="studentNameConfirmation" style="display: none; margin-top: 15px; background: #f0f0f0; padding: 15px; border-radius: 8px;">
                <h3>Confirm Your Details</h3>
                <p>Name: <strong id="confirmedStudentName"></strong></p>
                <p>Homeroom: <strong id="confirmedHomeroom"></strong></p>
            </div>
            
            <!-- Existing instructions and other content -->
            
            <button id="startQuizBtn" class="btn" onclick="startQuiz()" style="display: none;">
                I Understand - Start Quiz
            </button>
        </div>

        <!-- Rest of existing HTML remains the same -->
    </div>

    <script>
        const SUPABASE_URL = 'https://qedepuxzmdchujbipgax.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_JdSxu3gnEDIFaNtB1K4PNg_vqj0WoOI';

        let studentData = null;

        // Load class list with full details
        async function loadClassListFromRepo() {
            try {
                const response = await fetch('classlist.xls');
                if (!response.ok) throw new Error('Upload classlist.xls to repository');
                
                const data = await response.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                // Transform data into more usable structure
                return jsonData.map(row => ({
                    canteenCode: String(row['Canteen Code'] || '').trim(),
                    fullName: (row['FULL NAME'] || '').trim(),
                    homeroom: (row['HOMEROOM'] || '').trim()
                })).filter(student => student.canteenCode && student.fullName);
            } catch (error) {
                console.error('Error loading class list:', error);
                alert('Failed to load student data. Please contact your teacher.');
                return [];
            }
        }

        // Validate canteen code and confirm student details
        async function validateCanteenCode() {
            // First time loading data
            if (!studentData) {
                studentData = await loadClassListFromRepo();
            }

            const canteenCodeInput = document.getElementById('canteenCode');
            const canteenCode = canteenCodeInput.value.trim();
            
            // Validate format
            if (!/^[0-9]{6}$/.test(canteenCode)) {
                alert('Please enter a valid 6-digit Canteen Code');
                return false;
            }

            // Find student by canteen code
            const matchedStudent = studentData.find(student => 
                student.canteenCode === canteenCode
            );
            
            if (matchedStudent) {
                // Show confirmation section
                document.getElementById('confirmedStudentName').textContent = matchedStudent.fullName;
                document.getElementById('confirmedHomeroom').textContent = matchedStudent.homeroom;
                document.getElementById('studentNameConfirmation').style.display = 'block';
                document.getElementById('startQuizBtn').style.display = 'block';
                
                // Store student details for later use
                localStorage.setItem('studentFullName', matchedStudent.fullName);
                localStorage.setItem('studentHomeroom', matchedStudent.homeroom);
                localStorage.setItem('studentCanteenCode', canteenCode);
                
                return true;
            }
            
            alert('Canteen Code not found. Please check and try again.');
            return false;
        }

        // Attach event listener to canteen code input
        document.getElementById('canteenCode').addEventListener('input', function() {
            // Reset confirmation and start button
            document.getElementById('studentNameConfirmation').style.display = 'none';
            document.getElementById('startQuizBtn').style.display = 'none';
            
            // If input is 6 digits, attempt validation
            if (this.value.trim().length === 6 && /^[0-9]{6}$/.test(this.value)) {
                validateCanteenCode();
            }
        });

        // Modify existing startQuiz function
        function startQuiz() {
            // Retrieve stored student details
            const studentName = localStorage.getItem('studentFullName');
            
            if (!studentName) {
                alert('Please validate your Canteen Code first');
                return;
            }

            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('quizSection').classList.remove('hidden');
            
            startTime = new Date();
            quizActive = true;
            loadQuestion();
            startTimer();
        }

        // Modify saveToDatabase function to include all student details
        async function saveToDatabase(data) {
            const fullName = localStorage.getItem('studentFullName');
            const homeroom = localStorage.getItem('studentHomeroom');
            const canteenCode = localStorage.getItem('studentCanteenCode');

            const quizData = {
                ...data,
                student_name: fullName,
                homeroom: homeroom,
                canteen_code: canteenCode,
                assignment_name: 'Sentence Types Quiz',
                date_completed: new Date().toISOString()
            };

            // Existing Supabase submission logic remains the same
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/quiz_attempts`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(quizData)
                });
                
                if (response.ok) {
                    console.log('‚úÖ Quiz saved to database!');
                    return await response.json();
                } else {
                    console.error('‚ùå Error saving to database:', await response.text());
                }
            } catch (error) {
                console.error('‚ùå Network error:', error);
            }
        }

        // Rest of the existing script remains the same
    </script>
</body>
</html>
