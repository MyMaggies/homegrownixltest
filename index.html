<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentence Types Quiz</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }

        .student-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .student-info input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            user-select: text;
            -webkit-user-select: text;
        }

        .warning-banner {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .warning-banner.show {
            display: block;
        }

        .warning-banner h3 {
            color: #856404;
            margin-bottom: 5px;
        }

        .warning-banner p {
            color: #856404;
            font-size: 14px;
        }

        .activity-log {
            background: #ffe6e6;
            border: 2px solid #ff4444;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .activity-log.show {
            display: block;
        }

        .activity-log h4 {
            color: #cc0000;
            margin-bottom: 10px;
        }

        .activity-log ul {
            list-style: none;
            user-select: text;
            -webkit-user-select: text;
        }

        .activity-log li {
            color: #cc0000;
            font-size: 13px;
            padding: 3px 0;
        }

        .question-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-number {
            font-weight: bold;
            color: #667eea;
            font-size: 18px;
        }

        .sentence {
            font-size: 20px;
            font-style: italic;
            color: #333;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-left: 4px solid #667eea;
        }

        .options {
            display: grid;
            gap: 12px;
            margin-top: 20px;
        }

        .option {
            padding: 15px 20px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }

        .option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .option.correct {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .option.incorrect {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 20px;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .results {
            text-align: center;
            display: none;
        }

        .results.show {
            display: block;
        }

        .score {
            font-size: 48px;
            color: #667eea;
            font-weight: bold;
            margin: 20px 0;
        }

        .stats {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            user-select: text;
            -webkit-user-select: text;
        }

        .stats h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .instructions {
            background: #e7f3ff;
            border: 2px solid #2196F3;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .instructions h3 {
            color: #1976D2;
            margin-bottom: 10px;
        }

        .instructions ul {
            margin-left: 20px;
            color: #1976D2;
        }

        .hidden {
            display: none;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìù Sentence Types Quiz</h1>
        
        <div id="loginSection">
            <div class="student-info">
                <label for="studentName" style="display: block; margin-bottom: 8px; font-weight: bold;">Student Name:</label>
                <input type="text" id="studentName" placeholder="Enter your name" style="user-select: text;">
            </div>
            
            <div class="instructions">
                <h3>Instructions:</h3>
                <ul>
                    <li><strong>Declarative:</strong> Makes a statement (ends with .)</li>
                    <li><strong>Interrogative:</strong> Asks a question (ends with ?)</li>
                    <li><strong>Imperative:</strong> Gives a command (ends with . or !)</li>
                    <li><strong>Exclamatory:</strong> Shows strong emotion (ends with !)</li>
                </ul>
            </div>

            <div style="background: #fee; border: 3px solid #dc3545; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: #dc3545; margin-bottom: 10px;">‚ö†Ô∏è IMPORTANT RULES - READ CAREFULLY</h3>
                <ul style="color: #dc3545; font-weight: 600; line-height: 1.8;">
                    <li>üö´ Do NOT switch tabs or minimize this window</li>
                    <li>üö´ Do NOT use copy, paste, or right-click</li>
                    <li>üö´ Do NOT open other programs or websites</li>
                    <li>üìä All activity is tracked and reported to your teacher</li>
                    <li>‚ö†Ô∏è <strong>FIRST</strong> tab switch = 5-second warning with alarm</li>
                    <li>‚ö†Ô∏è <strong>SECOND</strong> tab switch = Quiz AUTO-SUBMITS (no second chance!)</li>
                    <li>‚úÖ Stay on this page until you finish!</li>
                </ul>
            </div>
            
            <button class="btn" onclick="startQuiz()">I Understand - Start Quiz</button>
        </div>

        <div id="quizSection" class="hidden">
            <div style="background: #fee; border: 2px solid #dc3545; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                <p style="color: #dc3545; font-weight: 600; font-size: 14px; margin: 0;">
                    ‚ö†Ô∏è WARNING: Do not switch tabs or minimize. First time = warning. Second time = auto-submit!
                </p>
            </div>

            <div id="countdownWarning" style="display: none; background: #dc3545; color: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; text-align: center; animation: pulse 0.5s infinite;">
                <h2 style="margin: 0 0 10px 0; font-size: 32px;">‚ö†Ô∏è RETURN NOW!</h2>
                <p style="margin: 0; font-size: 24px; font-weight: bold;">Quiz will auto-submit in <span id="countdownTimer">5</span> seconds</p>
                <p style="margin: 10px 0 0 0; font-size: 16px;">Click back to this tab immediately!</p>
            </div>

            <div class="activity-log" id="activityLog">
                <h4>üö® Flagged Activities:</h4>
                <ul id="logList"></ul>
            </div>

            <div class="question-card">
                <div class="question-header">
                    <span class="question-number" id="questionNumber">Question 1/10</span>
                </div>
                
                <div class="sentence" id="sentence"></div>
                
                <div class="options" id="options"></div>
            </div>

            <button class="btn" id="submitBtn" onclick="submitAnswer()">Submit Answer</button>
        </div>

        <div class="results" id="results">
            <h2>Quiz Complete! üéâ</h2>
            <div class="score" id="scoreDisplay"></div>
            <div class="stats" id="stats"></div>
            <button class="btn" onclick="location.reload()">Take Quiz Again</button>
        </div>
    </div>

    <script>
        // ============ SUPABASE CONFIGURATION ============
        // TODO: Add your Supabase credentials here after creating your account
        const SUPABASE_URL = 'https://qedepuxzmdchujbipgax.supabase.coE';  // Replace with your Supabase URL
        const SUPABASE_KEY = 'sb_publishable_JdSxu3gnEDIFaNtB1K4PNg_vqj0WoOI';     // Replace with your Supabase anon key

        // Function to save data to Supabase
        async function saveToDatabase(data) {
            // Skip if Supabase not configured yet
            if (SUPABASE_URL === 'YOUR_PROJECT_URL_HERE') {
                console.log('‚ö†Ô∏è Supabase not configured yet. Data:', data);
                return;
            }

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/quiz_attempts`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    console.log('‚úÖ Quiz saved to database!');
                    return await response.json();
                } else {
                    console.error('‚ùå Error saving to database:', await response.text());
                }
            } catch (error) {
                console.error('‚ùå Network error:', error);
            }
        }
        // ============ END SUPABASE CONFIGURATION ============

        // Question bank
        const questions = [
            { sentence: "What time does the movie start?", correct: "Interrogative" },
            { sentence: "The sun rises in the east.", correct: "Declarative" },
            { sentence: "Close the door behind you.", correct: "Imperative" },
            { sentence: "That was an amazing performance!", correct: "Exclamatory" },
            { sentence: "Where did you put my keys?", correct: "Interrogative" },
            { sentence: "Please turn off the lights.", correct: "Imperative" },
            { sentence: "She completed her homework on time.", correct: "Declarative" },
            { sentence: "I can't believe we won the game!", correct: "Exclamatory" },
            { sentence: "How do you solve this math problem?", correct: "Interrogative" },
            { sentence: "Stop talking during the test.", correct: "Imperative" },
            { sentence: "The cat is sleeping on the couch.", correct: "Declarative" },
            { sentence: "Watch out for that car!", correct: "Exclamatory" },
            { sentence: "When is your birthday?", correct: "Interrogative" },
            { sentence: "Help me carry these boxes.", correct: "Imperative" },
            { sentence: "What a beautiful sunset!", correct: "Exclamatory" },
            { sentence: "Dogs are loyal animals.", correct: "Declarative" },
            { sentence: "Did you finish your project?", correct: "Interrogative" },
            { sentence: "Be quiet in the library.", correct: "Imperative" },
            { sentence: "This is the best day ever!", correct: "Exclamatory" },
            { sentence: "The Earth orbits around the Sun.", correct: "Declarative" }
        ];

        const options = ["Declarative", "Interrogative", "Imperative", "Exclamatory"];

        let currentQuestion = 0;
        let score = 0;
        let selectedAnswer = null;
        let studentName = "";
        let startTime;
        let questionStartTime;
        let totalElapsedSeconds = 0;
        let timerInterval;
        let countdownInterval;

        // Activity tracking
        let activityLog = [];
        let tabSwitches = 0;
        let copyAttempts = 0;
        let pasteAttempts = 0;
        let rightClickAttempts = 0;
        let questionTimes = [];
        let quizActive = false;
        let warningGiven = false;
        let countdownActive = false;

        // Warning sound - simple beep using Web Audio API
        function playWarningSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800; // Hz - warning tone
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        // Shuffle and select 10 random questions
        let quizQuestions = [...questions].sort(() => Math.random() - 0.5).slice(0, 10);

        function startQuiz() {
            studentName = document.getElementById('studentName').value.trim();
            if (!studentName) {
                alert('Please enter your name to start the quiz.');
                return;
            }

            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('quizSection').classList.remove('hidden');
            
            startTime = new Date();
            quizActive = true;
            loadQuestion();
            startTimer();
        }

        function loadQuestion() {
            if (currentQuestion >= quizQuestions.length) {
                showResults();
                return;
            }

            questionStartTime = new Date();
            selectedAnswer = null;
            
            document.getElementById('questionNumber').textContent = `Question ${currentQuestion + 1}/${quizQuestions.length}`;
            document.getElementById('sentence').textContent = `"${quizQuestions[currentQuestion].sentence}"`;
            
            const optionsDiv = document.getElementById('options');
            optionsDiv.innerHTML = '';
            
            // Shuffle options for each question
            const shuffledOptions = [...options].sort(() => Math.random() - 0.5);
            
            shuffledOptions.forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.textContent = option;
                optionDiv.onclick = () => selectOption(option, optionDiv);
                optionsDiv.appendChild(optionDiv);
            });

            document.getElementById('submitBtn').disabled = true;
        }

        function selectOption(answer, element) {
            // Remove previous selection
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            element.classList.add('selected');
            selectedAnswer = answer;
            document.getElementById('submitBtn').disabled = false;
        }

        function submitAnswer() {
            if (!selectedAnswer) return;

            const questionEndTime = new Date();
            const timeSpent = (questionEndTime - questionStartTime) / 1000;
            questionTimes.push(timeSpent);

            const correct = selectedAnswer === quizQuestions[currentQuestion].correct;
            if (correct) score++;

            // Visual feedback
            document.querySelectorAll('.option').forEach(opt => {
                if (opt.textContent === quizQuestions[currentQuestion].correct) {
                    opt.classList.add('correct');
                } else if (opt.textContent === selectedAnswer && !correct) {
                    opt.classList.add('incorrect');
                }
                opt.style.pointerEvents = 'none';
            });

            document.getElementById('submitBtn').disabled = true;

            setTimeout(() => {
                currentQuestion++;
                loadQuestion();
            }, 1500);
        }

        function startTimer() {
            // Track time in background but don't display it
            timerInterval = setInterval(() => {
                totalElapsedSeconds++;
            }, 1000);
        }

        async function showResults() {
            clearInterval(timerInterval);
            quizActive = false;
            
            const endTime = new Date();
            const totalTime = Math.round((endTime - startTime) / 1000);
            const avgTime = questionTimes.length > 0 ? 
                (questionTimes.reduce((a, b) => a + b, 0) / questionTimes.length).toFixed(1) : '0';

            document.getElementById('quizSection').classList.add('hidden');
            document.getElementById('results').classList.add('show');
            
            const percentage = Math.round((score / quizQuestions.length) * 100);
            document.getElementById('scoreDisplay').textContent = `${score}/${quizQuestions.length} (${percentage}%)`;
            
            document.getElementById('stats').innerHTML = `
                <h3>Session Statistics</h3>
                <div class="stat-item">
                    <span>Student Name:</span>
                    <strong>${studentName}</strong>
                </div>
                <div class="stat-item">
                    <span>Total Time:</span>
                    <strong>${totalTime} seconds</strong>
                </div>
                <div class="stat-item">
                    <span>Average Time per Question:</span>
                    <strong>${avgTime} seconds</strong>
                </div>
                <div class="stat-item">
                    <span>Tab Switches:</span>
                    <strong style="color: ${tabSwitches > 0 ? '#dc3545' : '#28a745'}">${tabSwitches}</strong>
                </div>
                <div class="stat-item">
                    <span>Copy Attempts:</span>
                    <strong style="color: ${copyAttempts > 0 ? '#dc3545' : '#28a745'}">${copyAttempts}</strong>
                </div>
                <div class="stat-item">
                    <span>Paste Attempts:</span>
                    <strong style="color: ${pasteAttempts > 0 ? '#dc3545' : '#28a745'}">${pasteAttempts}</strong>
                </div>
                <div class="stat-item">
                    <span>Right-Click Attempts:</span>
                    <strong style="color: ${rightClickAttempts > 0 ? '#dc3545' : '#28a745'}">${rightClickAttempts}</strong>
                </div>
            `;

            // Calculate how many questions were answered vs. total
            const questionsAnswered = currentQuestion; // currentQuestion is the index, so it equals number answered

            // Save to database
            const quizData = {
                student_name: studentName,
                assignment_name: 'Sentence Types Quiz',
                completed: (currentQuestion >= quizQuestions.length), // Only true if all questions answered
                score: percentage,
                total_questions: quizQuestions.length,
                date_completed: new Date().toISOString(),
                time_seconds: totalTime,
                tab_switches: tabSwitches,
                copy_attempts: copyAttempts,
                paste_attempts: pasteAttempts,
                rightclick_attempts: rightClickAttempts
            };

            await saveToDatabase(quizData);

            // Also log to console for debugging
            console.log('QUIZ RESULTS:', quizData);
        }

        function autoSubmitQuiz() {
            // Force submit quiz with current progress
            logActivity('QUIZ AUTO-SUBMITTED - Second tab switch detected', 'critical');
            
            alert('‚ö†Ô∏è Quiz automatically submitted because you switched tabs a SECOND time.\n\nOnly your current answers have been recorded.');
            
            // Force end quiz
            showResults();
        }

        function startCountdown() {
            if (countdownActive) return; // Prevent multiple countdowns
            
            countdownActive = true;
            let secondsLeft = 5;
            
            // Play warning sound
            playWarningSound();
            
            // Show countdown warning
            document.getElementById('countdownWarning').style.display = 'block';
            document.getElementById('countdownTimer').textContent = secondsLeft;
            
            countdownInterval = setInterval(() => {
                secondsLeft--;
                document.getElementById('countdownTimer').textContent = secondsLeft;
                
                // Play beep each second
                if (secondsLeft > 0) {
                    playWarningSound();
                }
                
                if (secondsLeft <= 0) {
                    clearInterval(countdownInterval);
                    countdownActive = false;
                    autoSubmitQuiz();
                }
            }, 1000);
        }

        function cancelCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            countdownActive = false;
            document.getElementById('countdownWarning').style.display = 'none';
        }

        function logActivity(activity, severity = 'medium') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${activity}`;
            activityLog.push({ timestamp, activity, severity, questionNumber: currentQuestion + 1 });
            
            const logList = document.getElementById('logList');
            const li = document.createElement('li');
            li.textContent = logEntry;
            logList.appendChild(li);
            
            document.getElementById('activityLog').classList.add('show');
            
            console.log('ACTIVITY LOGGED:', { timestamp, activity, questionNumber: currentQuestion + 1 });
        }

        // ============ ANTI-CHEATING MEASURES ============

        // Detect tab/window changes - FIRST TIME = WARNING, SECOND TIME = AUTO SUBMIT
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && quizActive && !countdownActive) {
                tabSwitches++;
                
                if (!warningGiven) {
                    // FIRST OFFENSE - Give warning with countdown
                    warningGiven = true;
                    logActivity('‚ö†Ô∏è FIRST WARNING - Tab/Window switched away - 5 second countdown started', 'high');
                    startCountdown();
                } else {
                    // SECOND OFFENSE - Auto submit immediately
                    logActivity('‚ùå SECOND OFFENSE - Tab/Window switched away - FORCE SUBMIT', 'critical');
                    cancelCountdown();
                    autoSubmitQuiz();
                }
            } else if (!document.hidden && countdownActive) {
                // Student returned - cancel countdown
                logActivity('‚úÖ Student returned to tab - Countdown cancelled', 'medium');
                cancelCountdown();
            }
        });

        window.addEventListener('blur', function() {
            if (quizActive && !countdownActive && !document.hidden) {
                // Window lost focus but tab is still visible (e.g., clicked outside browser)
                tabSwitches++;
                
                if (!warningGiven) {
                    warningGiven = true;
                    logActivity('‚ö†Ô∏è FIRST WARNING - Window lost focus - 5 second countdown started', 'high');
                    startCountdown();
                } else {
                    logActivity('‚ùå SECOND OFFENSE - Window lost focus - FORCE SUBMIT', 'critical');
                    cancelCountdown();
                    autoSubmitQuiz();
                }
            }
        });

        window.addEventListener('focus', function() {
            if (quizActive && countdownActive) {
                // Window regained focus - cancel countdown
                logActivity('‚úÖ Window regained focus - Countdown cancelled', 'medium');
                cancelCountdown();
            }
        });

        // Prevent copy
        document.addEventListener('copy', function(e) {
            if (!e.target.closest('.stats') && !e.target.closest('.activity-log') && quizActive) {
                e.preventDefault();
                copyAttempts++;
                logActivity('Copy attempt blocked', 'high');
                return false;
            }
        });

        // Prevent cut
        document.addEventListener('cut', function(e) {
            if (!e.target.closest('.stats') && !e.target.closest('.activity-log') && quizActive) {
                e.preventDefault();
                copyAttempts++;
                logActivity('Cut attempt blocked', 'high');
                return false;
            }
        });

        // Prevent paste
        document.addEventListener('paste', function(e) {
            if (e.target.id !== 'studentName' && quizActive) {
                e.preventDefault();
                pasteAttempts++;
                logActivity('Paste attempt blocked', 'high');
                return false;
            }
        });

        // Prevent right-click
        document.addEventListener('contextmenu', function(e) {
            if (!e.target.closest('.stats') && !e.target.closest('.activity-log') && quizActive) {
                e.preventDefault();
                rightClickAttempts++;
                logActivity('Right-click attempt', 'medium');
                return false;
            }
        });

        // Detect keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (!quizActive) return;
            
            // Ctrl+C, Ctrl+X, Ctrl+V
            if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'x' || e.key === 'v')) {
                if (!e.target.closest('.stats') && !e.target.closest('.activity-log')) {
                    e.preventDefault();
                    if (e.key === 'c' || e.key === 'x') {
                        copyAttempts++;
                    } else {
                        pasteAttempts++;
                    }
                    logActivity(`Keyboard shortcut blocked: Ctrl+${e.key.toUpperCase()}`, 'high');
                }
            }
            
            // F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+Shift+C, Ctrl+U
            if (e.key === 'F12' || 
                ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) ||
                ((e.ctrlKey || e.metaKey) && e.key === 'u')) {
                e.preventDefault();
                logActivity('Developer tools shortcut blocked', 'high');
                return false;
            }

            // Print Screen
            if (e.key === 'PrintScreen') {
                logActivity('Print Screen key pressed', 'high');
            }

            // Alt+Tab, Cmd+Tab (can't fully prevent but log it)
            if ((e.altKey && e.key === 'Tab') || (e.metaKey && e.key === 'Tab')) {
                logActivity('Alt+Tab/Cmd+Tab pressed - Window switch attempt', 'critical');
            }
        });

        // Detect if user tries to leave page
        window.addEventListener('beforeunload', function(e) {
            if (quizActive) {
                e.preventDefault();
                e.returnValue = '';
                return 'Your quiz is in progress. If you leave, your current answers will be submitted.';
            }
        });
    </script>
</body>
</html>
