<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentence Types Homework</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Paste the entire original CSS from the previous index.html here */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
        }

        /* ... (rest of the original CSS) ... */
    </style>
</head>
<body>
    <div class="container">
        <h1>üìù Sentence Types Quiz</h1>
        
        <div id="loginSection">
            <div class="student-info">
                <label for="canteenCode" style="display: block; margin-bottom: 8px; font-weight: bold;">Canteen Code:</label>
                <input 
                    type="text" 
                    id="canteenCode" 
                    placeholder="Enter your 6-digit Canteen Code" 
                    pattern="[0-9]{6}" 
                    maxlength="6" 
                    required 
                    style="user-select: text;"
                >
                <small style="color: #666; display: block; margin-top: 5px;">
                    Your 6-digit Canteen Code can be found on your school ID
                </small>
            </div>
            
            <div id="studentNameConfirmation" style="display: none; margin-top: 15px; background: #f0f0f0; padding: 15px; border-radius: 8px;">
                <h3>Confirm Your Details</h3>
                <p>Name: <strong id="confirmedStudentName"></strong></p>
                <p>Homeroom: <strong id="confirmedHomeroom"></strong></p>
            </div>
            
            <div class="instructions">
                <h3>Instructions:</h3>
                <ul>
                    <li><strong>Declarative:</strong> Makes a statement (ends with .)</li>
                    <li><strong>Interrogative:</strong> Asks a question (ends with ?)</li>
                    <li><strong>Imperative:</strong> Gives a command (ends with . or !)</li>
                    <li><strong>Exclamatory:</strong> Shows strong emotion (ends with !)</li>
                </ul>
            </div>

            <div style="background: #fee; border: 3px solid #dc3545; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: #dc3545; margin-bottom: 10px;">‚ö†Ô∏è IMPORTANT RULES - READ CAREFULLY</h3>
                <ul style="color: #dc3545; font-weight: 600; line-height: 1.8;">
                    <li>üö´ Do NOT switch tabs or minimize this window</li>
                    <li>üö´ Do NOT use copy, paste, or right-click</li>
                    <li>üö´ Do NOT open other programs or websites</li>
                    <li>üìä All activity is tracked and reported to your teacher</li>
                    <li>‚ö†Ô∏è <strong>FIRST</strong> tab switch = 5-second warning with alarm</li>
                    <li>‚ö†Ô∏è <strong>SECOND</strong> tab switch = Quiz AUTO-SUBMITS (no second chance!)</li>
                    <li>‚úÖ Stay on this page until you finish!</li>
                </ul>
            </div>
            
            <button id="startQuizBtn" class="btn" style="display: none;" onclick="startQuiz()">
                I Understand - Start Quiz
            </button>
        </div>

        <div id="quizSection" class="hidden">
            <!-- Existing quiz section HTML from previous version -->
            <div style="background: #fee; border: 2px solid #dc3545; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                <p style="color: #dc3545; font-weight: 600; font-size: 14px; margin: 0;">
                    ‚ö†Ô∏è WARNING: Do not switch tabs or minimize. First time = warning. Second time = auto-submit!
                </p>
            </div>

            <div id="countdownWarning" style="display: none; background: #dc3545; color: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; text-align: center; animation: pulse 0.5s infinite;">
                <h2 style="margin: 0 0 10px 0; font-size: 32px;">‚ö†Ô∏è RETURN NOW!</h2>
                <p style="margin: 0; font-size: 24px; font-weight: bold;">Quiz will auto-submit in <span id="countdownTimer">5</span> seconds</p>
                <p style="margin: 10px 0 0 0; font-size: 16px;">Click back to this tab immediately!</p>
            </div>

            <div class="activity-log" id="activityLog">
                <h4>üö® Flagged Activities:</h4>
                <ul id="logList"></ul>
            </div>

            <div class="question-card">
                <div class="question-header">
                    <span class="question-number" id="questionNumber">Question 1/10</span>
                </div>
                
                <div class="sentence" id="sentence"></div>
                
                <div class="options" id="options"></div>
            </div>

            <button class="btn" id="submitBtn" onclick="submitAnswer()">Submit Answer</button>
        </div>

        <div class="results" id="results">
            <h2>Quiz Complete! üéâ</h2>
            <div class="score" id="scoreDisplay"></div>
            <div class="stats" id="stats"></div>
            <button class="btn" onclick="location.reload()">Take Quiz Again</button>
        </div>
    </div>

    <script>
        // Existing quiz scripts (questions, anti-cheating measures, etc.)
        // Existing Supabase configuration
        
        let studentData = null;

        // Load class list with full details
        async function loadClassListFromRepo() {
            try {
                const response = await fetch('classlist.xls');
                if (!response.ok) throw new Error('Upload classlist.xls to repository');
                
                const data = await response.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                // Transform data into more usable structure
                return jsonData.map(row => ({
                    canteenCode: String(row['Canteen Code'] || '').trim(),
                    fullName: (row['FULL NAME'] || '').trim(),
                    homeroom: (row['HOMEROOM'] || '').trim()
                })).filter(student => student.canteenCode && student.fullName);
            } catch (error) {
                console.error('Error loading class list:', error);
                alert('Failed to load student data. Please contact your teacher.');
                return [];
            }
        }

        // Validate canteen code and confirm student details
        async function validateCanteenCode() {
            // First time loading data
            if (!studentData) {
                studentData = await loadClassListFromRepo();
            }

            const canteenCodeInput = document.getElementById('canteenCode');
            const canteenCode = canteenCodeInput.value.trim();
            
            // Validate format
            if (!/^[0-9]{6}$/.test(canteenCode)) {
                alert('Please enter a valid 6-digit Canteen Code');
                return false;
            }

            // Find student by canteen code
            const matchedStudent = studentData.find(student => 
                student.canteenCode === canteenCode
            );
            
            if (matchedStudent) {
                // Show confirmation section
                document.getElementById('confirmedStudentName').textContent = matchedStudent.fullName;
                document.getElementById('confirmedHomeroom').textContent = matchedStudent.homeroom;
                document.getElementById('studentNameConfirmation').style.display = 'block';
                document.getElementById('startQuizBtn').style.display = 'block';
                
                // Store student details for later use
                localStorage.setItem('studentFullName', matchedStudent.fullName);
                localStorage.setItem('studentHomeroom', matchedStudent.homeroom);
                localStorage.setItem('studentCanteenCode', canteenCode);
                
                return true;
            }
            
            alert('Canteen Code not found. Please check and try again.');
            return false;
        }

        // Attach event listener to canteen code input
        document.getElementById('canteenCode').addEventListener('input', function() {
            // Reset confirmation and start button
            document.getElementById('studentNameConfirmation').style.display = 'none';
            document.getElementById('startQuizBtn').style.display = 'none';
            
            // If input is 6 digits, attempt validation
            if (this.value.trim().length === 6 && /^[0-9]{6}$/.test(this.value)) {
                validateCanteenCode();
            }
        });

        // Modify existing startQuiz function
        function startQuiz() {
            // Retrieve stored student details
            const studentName = localStorage.getItem('studentFullName');
            
            if (!studentName) {
                alert('Please validate your Canteen Code first');
                return;
            }

            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('quizSection').classList.remove('hidden');
            
            startTime = new Date();
            quizActive = true;
            loadQuestion();
            startTimer();
        }

        // Modify saveToDatabase function to include all student details
        async function saveToDatabase(data) {
            const fullName = localStorage.getItem('studentFullName');
            const homeroom = localStorage.getItem('studentHomeroom');
            const canteenCode = localStorage.getItem('studentCanteenCode');

            const quizData = {
                ...data,
                student_name: fullName,
                homeroom: homeroom,
                canteen_code: canteenCode,
                assignment_name: 'Sentence Types Quiz',
                date_completed: new Date().toISOString()
            };

            // Existing Supabase submission logic
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/quiz_attempts`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(quizData)
                });
                
                if (response.ok) {
                    console.log('‚úÖ Quiz saved to database!');
                    return await response.json();
                } else {
                    console.error('‚ùå Error saving to database:', await response.text());
                }
            } catch (error) {
                console.error('‚ùå Network error:', error);
            }
        }

        // Rest of the existing quiz script 
        // (keep ALL the original anti-cheating measures, question handling, etc.)
        // Include the entire original script from the previous version
        // Question bank, startQuiz, loadQuestion, submitAnswer, etc.
    </script>
</body>
</html>
