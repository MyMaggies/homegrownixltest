<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentence Types Quiz</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }

        .student-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .student-info input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            user-select: text;
            -webkit-user-select: text;
        }

        .quiz-instructions {
            background: #f0f8ff;
            border: 2px solid #4a90e2;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            color: #2c3e50;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 20px;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #studentNameConfirmation {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .question-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .sentence {
            font-size: 20px;
            font-style: italic;
            color: #333;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-left: 4px solid #667eea;
        }

        .options {
            display: grid;
            gap: 12px;
            margin-top: 20px;
        }

        .option {
            padding: 15px 20px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }

        .option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .option.correct {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .option.incorrect {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìù Sentence Types Quiz</h1>
        
        <div id="canteenCodeSection">
            <div class="student-info">
                <label for="canteenCode" style="display: block; margin-bottom: 8px; font-weight: bold;">Canteen Code:</label>
                <input 
                    type="text" 
                    id="canteenCode" 
                    placeholder="Enter your 6-digit Canteen Code" 
                    pattern="[0-9]{6}" 
                    maxlength="6" 
                    required 
                    style="user-select: text;"
                >
                <small style="color: #666; display: block; margin-top: 5px;">
                    Your 6-digit Canteen Code can be found on your school ID
                </small>
            </div>
            
            <div id="studentNameConfirmation" style="display: none;">
                <h3>Confirm Your Details</h3>
                <p>Name: <strong id="confirmedStudentName"></strong></p>
                <p>Homeroom: <strong id="confirmedHomeroom"></strong></p>
            </div>
            
            <div id="quizInstructions" class="quiz-instructions" style="display: none;">
                <h4>üîç Quiz Instructions</h4>
                <p>Please ensure you:</p>
                <ul>
                    <li>Stay on this page throughout the quiz</li>
                    <li>Do not switch tabs or minimize the window</li>
                    <li>Complete the quiz in one sitting</li>
                </ul>
                <p>If you switch tabs, the quiz may automatically submit.</p>
            </div>
            
            <button id="proceedToQuizBtn" class="btn" style="display: none;">
                Proceed to Quiz
            </button>
        </div>

        <div id="quizSection" class="hidden">
            <div class="question-card">
                <div class="question-header">
                    <span class="question-number" id="questionNumber">Question 1/10</span>
                </div>
                
                <div class="sentence" id="sentence"></div>
                
                <div class="options" id="options"></div>
            </div>

            <button class="btn" id="submitBtn" onclick="submitAnswer()">Submit Answer</button>
        </div>

        <div class="hidden" id="results">
            <h2>Quiz Complete! üéâ</h2>
            <div class="score" id="scoreDisplay"></div>
            <div class="stats" id="stats"></div>
            <button class="btn" onclick="location.reload()">Take Quiz Again</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://qedepuxzmdchujbipgax.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_JdSxu3gnEDIFaNtB1K4PNg_vqj0WoOI';

        let studentData = null;
        let currentQuestion = 0;
        let score = 0;
        let selectedAnswer = null;
        let startTime;
        let quizQuestions = [];

        // Anti-cheating global variables
        let tabSwitches = 0;
        let copyAttempts = 0;
        let pasteAttempts = 0;
        let rightClickAttempts = 0;
        let quizActive = false;
        let warningGiven = false;
        let countdownActive = false;
        let countdownInterval = null;

        // Question bank
        const questions = [
            { sentence: "What time does the movie start?", correct: "Interrogative" },
            { sentence: "The sun rises in the east.", correct: "Declarative" },
            { sentence: "Close the door behind you.", correct: "Imperative" },
            { sentence: "That was an amazing performance!", correct: "Exclamatory" },
            { sentence: "Where did you put my keys?", correct: "Interrogative" },
            { sentence: "Please turn off the lights.", correct: "Imperative" },
            { sentence: "She completed her homework on time.", correct: "Declarative" },
            { sentence: "I can't believe we won the game!", correct: "Exclamatory" },
            { sentence: "How do you solve this math problem?", correct: "Interrogative" },
            { sentence: "Stop talking during the test.", correct: "Imperative" },
            { sentence: "The cat is sleeping on the couch.", correct: "Declarative" },
            { sentence: "Watch out for that car!", correct: "Exclamatory" },
            { sentence: "When is your birthday?", correct: "Interrogative" },
            { sentence: "Help me carry these boxes.", correct: "Imperative" },
            { sentence: "What a beautiful sunset!", correct: "Exclamatory" },
            { sentence: "Dogs are loyal animals.", correct: "Declarative" },
            { sentence: "Did you finish your project?", correct: "Interrogative" },
            { sentence: "Be quiet in the library.", correct: "Imperative" },
            { sentence: "This is the best day ever!", correct: "Exclamatory" },
            { sentence: "The Earth orbits around the Sun.", correct: "Declarative" }
        ];

        const options = ["Declarative", "Interrogative", "Imperative", "Exclamatory"];

        // Load class list
        async function loadClassListFromRepo() {
            const response = await fetch('classlist.xls');
            const data = await response.arrayBuffer();
            const workbook = XLSX.read(data, { type: 'array' });
            const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            
            return jsonData.map(row => ({
                canteenCode: String(row['Canteen Code'] || '').trim(),
                fullName: (row['FULL NAME'] || '').trim(),
                homeroom: (row['HOMEROOM'] || '').trim()
            })).filter(student => student.fullName);
        }

        // Validate canteen code
        async function validateCanteenCode() {
            if (!studentData) {
                studentData = await loadClassListFromRepo();
            }

            const canteenCodeInput = document.getElementById('canteenCode');
            const canteenCode = canteenCodeInput.value.trim();
            
            if (!/^[0-9]{6}$/.test(canteenCode)) {
                alert('Please enter a valid 6-digit Canteen Code');
                return false;
            }

            const matchedStudent = studentData.find(student => 
                student.canteenCode === canteenCode
            );
            
            if (matchedStudent) {
                document.getElementById('confirmedStudentName').textContent = matchedStudent.fullName;
                document.getElementById('confirmedHomeroom').textContent = matchedStudent.homeroom;
                document.getElementById('studentNameConfirmation').style.display = 'block';
                document.getElementById('quizInstructions').style.display = 'block';
                document.getElementById('proceedToQuizBtn').style.display = 'block';
                
                localStorage.setItem('studentFullName', matchedStudent.fullName);
                localStorage.setItem('studentHomeroom', matchedStudent.homeroom);
                localStorage.setItem('studentCanteenCode', canteenCode);
                
                return true;
            }
            
            alert('Canteen Code not found. Please check and try again.');
            return false;
        }

        // Event listener for canteen code input
        document.getElementById('canteenCode').addEventListener('input', function() {
            document.getElementById('studentNameConfirmation').style.display = 'none';
            document.getElementById('quizInstructions').style.display = 'none';
            document.getElementById('proceedToQuizBtn').style.display = 'none';
            
            if (this.value.trim().length === 6 && /^[0-9]{6}$/.test(this.value)) {
                validateCanteenCode();
            }
        });

        // Event listener for proceed to quiz button
        document.getElementById('proceedToQuizBtn').addEventListener('click', function() {
            document.getElementById('canteenCodeSection').classList.add('hidden');
            document.getElementById('quizSection').classList.remove('hidden');
            
            quizQuestions = [...questions].sort(() => Math.random() - 0.5).slice(0, 10);
            
            startTime = new Date();
            quizActive = true;
            currentQuestion = 0;
            score = 0;
            loadQuestion();
        });

        // Load question
        function loadQuestion() {
            if (currentQuestion >= quizQuestions.length) {
                showResults();
                return;
            }

            selectedAnswer = null;
            
            document.getElementById('questionNumber').textContent = `Question ${currentQuestion + 1}/${quizQuestions.length}`;
            document.getElementById('sentence').textContent = `"${quizQuestions[currentQuestion].sentence}"`;
            
            const optionsDiv = document.getElementById('options');
            optionsDiv.innerHTML = '';
            
            const shuffledOptions = [...options].sort(() => Math.random() - 0.5);
            
            shuffledOptions.forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.textContent = option;
                optionDiv.onclick = () => selectOption(option, optionDiv);
                optionsDiv.appendChild(optionDiv);
            });

            document.getElementById('submitBtn').disabled = true;
        }

        // Select answer
        function selectOption(answer, element) {
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            element.classList.add('selected');
            selectedAnswer = answer;
            document.getElementById('submitBtn').disabled = false;
        }

        // Submit answer
        function submitAnswer() {
            if (!selectedAnswer) return;

            const correct = selectedAnswer === quizQuestions[currentQuestion].correct;
            if (correct) score++;

            document.querySelectorAll('.option').forEach(opt => {
                if (opt.textContent === quizQuestions[currentQuestion].correct) {
                    opt.classList.add('correct');
                } else if (opt.textContent === selectedAnswer && !correct) {
                    opt.classList.add('incorrect');
                }
                opt.style.pointerEvents = 'none';
            });

            document.getElementById('submitBtn').disabled = true;

            setTimeout(() => {
                currentQuestion++;
                loadQuestion();
            }, 1500);
        }

        // Show results
        function showResults() {
            document.getElementById('quizSection').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');
            
            const percentage = Math.round((score / quizQuestions.length) * 100);
            document.getElementById('scoreDisplay').textContent = `${score}/${quizQuestions.length} (${percentage}%)`;
            
            const quizData = {
                student_name: localStorage.getItem('studentFullName'),
                homeroom: localStorage.getItem('studentHomeroom'),
                canteen_code: localStorage.getItem('studentCanteenCode'),
                assignment_name: 'Sentence Types Quiz',
                completed: true,
                score: percentage,
                total_questions: quizQuestions.length,
                date_completed: new Date().toISOString(),
                tab_switches: tabSwitches,
                copy_attempts: copyAttempts,
                paste_attempts: pasteAttempts,
                right_click_attempts: rightClickAttempts
            };

            saveToDatabase(quizData);
        }

        // Save to database
        async function saveToDatabase(data) {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/quiz_attempts`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    console.log('‚úÖ Quiz saved to database!');
                } else {
                    console.error('‚ùå Error saving to database:', await response.text());
                }
            } catch (error) {
                console.error('‚ùå Network error:', error);
            }
        }

        
        // Anti-cheating event listeners
      function playTabSwitchBeep() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        // Create a sharp, attention-grabbing beep
        oscillator.type = 'sine';  // A clean sine wave
        oscillator.frequency.value = 800;  // High pitch

        // Quick fade in and out for a sharp beep
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.01);
        gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.1);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1);
    } catch (error) {
        console.error('Error playing beep sound:', error);
    }
}

// Modify your existing visibility change event listener
document.addEventListener('visibilitychange', function() {
    if (document.hidden && quizActive && !countdownActive) {
        tabSwitches++;
        
        // Play the beep sound
        playTabSwitchBeep();
        
        if (!warningGiven) {
            warningGiven = true;
            logActivity('‚ö†Ô∏è FIRST WARNING - Tab/Window switched away', 'high');
            startCountdown();
        } else {
            logActivity('‚ùå SECOND OFFENSE - Tab/Window switched away', 'critical');
            cancelCountdown();
            autoSubmitQuiz();
        }
    } else if (!document.hidden && countdownActive) {
        logActivity('‚úÖ Student returned to tab', 'medium');
        cancelCountdown();
    }
});

        window.addEventListener('blur', function() {
    if (quizActive && !countdownActive && !document.hidden) {
        // Play the beep sound
        playTabSwitchBeep();
        
        tabSwitches++;
        
        if (!warningGiven) {
            warningGiven = true;
            logActivity('‚ö†Ô∏è FIRST WARNING - Window lost focus', 'high');
            startCountdown();
        } else {
            logActivity('‚ùå SECOND OFFENSE - Window lost focus', 'critical');
            cancelCountdown();
            autoSubmitQuiz();
        }
    }
});

        document.addEventListener('copy', function(e) {
            if (quizActive) {
                e.preventDefault();
                copyAttempts++;
                logActivity('Copy attempt blocked', 'high');
                return false;
            }
        });

        document.addEventListener('paste', function(e) {
            if (quizActive) {
                e.preventDefault();
                pasteAttempts++;
                logActivity('Paste attempt blocked', 'high');
                return false;
            }
        });

        document.addEventListener('contextmenu', function(e) {
            if (quizActive) {
                e.preventDefault();
                rightClickAttempts++;
                logActivity('Right-click attempt', 'medium');
                return false;
            }
        });

        // Logging and countdown functions
        function logActivity(activity, severity = 'medium') {
            console.log('ACTIVITY LOGGED:', { timestamp: new Date().toLocaleTimeString(), activity });
        }

        function startCountdown() {
            if (countdownActive) return;
            
            countdownActive = true;
            let secondsLeft = 5;
            
            document.getElementById('countdownWarning').style.display = 'block';
            document.getElementById('countdownTimer').textContent = secondsLeft;
            
            countdownInterval = setInterval(() => {
                secondsLeft--;
                document.getElementById('countdownTimer').textContent = secondsLeft;
                
                if (secondsLeft <= 0) {
                    clearInterval(countdownInterval);
                    countdownActive = false;
                    autoSubmitQuiz();
                }
            }, 1000);
        }

        function cancelCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            countdownActive = false;
            document.getElementById('countdownWarning').style.display = 'none';
        }

        function autoSubmitQuiz() {
            alert('Quiz automatically submitted due to switching tabs.');
            showResults();
        }
    </script>
</body>
</html>
