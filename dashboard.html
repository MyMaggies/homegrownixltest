<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header h1 { margin-bottom: 10px; }
        .header p { opacity: 0.9; margin-bottom: 20px; }
        .teacher-input-box { background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; margin-top: 20px; }
        .teacher-input-box label { display: block; margin-bottom: 8px; font-weight: 600; }
        .teacher-input-box input { width: 100%; max-width: 400px; padding: 10px; border: none; border-radius: 5px; font-size: 16px; }
        .main-section { background: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .main-section h2 { margin-bottom: 20px; color: #2d3748; }
        .btn { padding: 15px 30px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 16px; display: inline-block; }
        .btn-danger { background: #f56565; color: white; }
        .btn-danger:hover { background: #e53e3e; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(245, 101, 101, 0.3); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .alert { padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .alert-info { background: #bee3f8; color: #2c5282; border-left: 4px solid #3182ce; }
        .alert-success { background: #c6f6d5; color: #22543d; border-left: 4px solid #48bb78; }
        .alert-error { background: #fed7d7; color: #742a2a; border-left: 4px solid #f56565; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; color: #4a5568; margin-bottom: 8px; }
        .form-group input { width: 100%; max-width: 400px; padding: 10px; border: 2px solid #e1e8ed; border-radius: 5px; font-size: 14px; }
        .form-group small { display: block; color: #718096; margin-top: 5px; font-size: 12px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-card h3 { color: #666; font-size: 14px; margin-bottom: 10px; text-transform: uppercase; }
        .stat-card .number { font-size: 36px; font-weight: bold; color: #667eea; }
        .stat-card.warning .number { color: #f56565; }
        .stat-card.success .number { color: #48bb78; }
        .student-list { background: #f7fafc; padding: 20px; border-radius: 5px; margin-top: 20px; max-height: 400px; overflow-y: auto; }
        .student-list h4 { margin-bottom: 10px; color: #2d3748; }
        .student-item { padding: 8px 12px; background: white; margin-bottom: 5px; border-radius: 3px; font-size: 14px; display: flex; justify-content: space-between; }
        .student-item .name { font-weight: 500; }
        .student-item .reason { color: #666; font-size: 12px; }
        .loading { display: none; text-align: center; padding: 30px; }
        .loading.show { display: block; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .status-indicator.loading { background: #ffc107; }
        .status-indicator.ready { background: #48bb78; }
        .status-indicator.error { background: #f56565; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ“Š Teacher Dashboard</h1>
        <p>Automated Homework Notification System</p>
        <div class="teacher-input-box">
            <label for="headerTeacherName">Your Name (for PDF signatures):</label>
            <input type="text" id="headerTeacherName" placeholder="e.g., Mr. Louis Pienaar" onchange="updateTeacherName()">
        </div>
    </div>

    <div class="main-section">
        <h2>ðŸ“‹ Generate Homework Letters</h2>
        
        <div class="alert alert-info">
            <strong>How it works:</strong> System automatically loads classlist.xlsx from repository and compares with quiz database. PDFs generated for students who: didn't take quiz, scored &lt;70%, or didn't complete.
        </div>

        <div id="systemStatus" class="alert alert-info">
            <span class="status-indicator loading"></span>
            <strong>Loading...</strong> Checking class list and database...
        </div>

        <div class="form-group">
            <label for="assignmentName">Assignment Name</label>
            <input type="text" id="assignmentName" value="Sentences Type Quiz">
            <small>This will appear in the letter to parents</small>
        </div>

        <div id="statsSection" class="stats" style="display: none;">
            <div class="stat-card">
                <h3>Total in Class</h3>
                <div class="number" id="totalStudents">0</div>
            </div>
            <div class="stat-card success">
                <h3>Completed (â‰¥70%)</h3>
                <div class="number" id="completedStudents">0</div>
            </div>
            <div class="stat-card warning">
                <h3>Need Letters</h3>
                <div class="number" id="incompleteStudents">0</div>
            </div>
        </div>

        <div id="studentListPreview" style="display: none;">
            <div class="student-list">
                <h4>Students Who Will Receive Letters:</h4>
                <div id="studentListContent"></div>
            </div>
        </div>

        <button id="generateBtn" class="btn btn-danger" onclick="generateAllPDFs()" disabled style="font-size: 18px; padding: 20px 40px; margin-top: 20px;">
            ðŸ“„ Generate PDF Letters (ZIP)
        </button>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p style="font-weight: 600; color: #667eea;">Generating PDFs...</p>
            <p style="font-size: 14px; color: #666; margin-top: 10px;">This may take a minute</p>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://qedepuxzmdchujbipgax.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_JdSxu3gnEDIFaNtB1K4PNg_vqj0WoOI';

        async function fetchFromDatabase() {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/quiz_attempts?select=*`, {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
            });
            return response.ok ? response.json() : [];
        }

        let classList = [], quizData = [], templateImage = null, studentsNeedingLetters = [];
        const templateSettings = { contentX: 25, contentY: 50, contentWidth: 160, lineHeight: 6 };
        let teacherName = "Mr. Louis Pienaar";

        document.addEventListener('DOMContentLoaded', async function() {
            loadSavedTeacherName();
            loadSavedAssignment();
            await initializeSystem();
        });

        async function initializeSystem() {
            try {
                await loadLetterheadFromRepo();
                await loadClassListFromRepo();
                await loadQuizData();
                analyzeData();
                
                document.getElementById('systemStatus').className = 'alert alert-success';
                document.getElementById('systemStatus').innerHTML = `<span class="status-indicator ready"></span><strong>Ready!</strong> ${classList.length} students in class. ${studentsNeedingLetters.length} need letters.`;
                document.getElementById('generateBtn').disabled = false;
            } catch (error) {
                document.getElementById('systemStatus').className = 'alert alert-error';
                document.getElementById('systemStatus').innerHTML = `<span class="status-indicator error"></span><strong>Error:</strong> ${error.message}`;
            }
        }

        async function loadLetterheadFromRepo() {
            const response = await fetch('letterhead.png');
            if (!response.ok) throw new Error('Upload letterhead.png to repository');
            const blob = await response.blob();
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => { templateImage = e.target.result; resolve(); };
                reader.onerror = () => reject(new Error('Failed to read letterhead'));
                reader.readAsDataURL(blob);
            });
        }

        async function loadClassListFromRepo() {
            const response = await fetch('classlist.xlsx');
            if (!response.ok) throw new Error('Upload classlist.xlsx to repository');
            const data = await response.arrayBuffer();
            const workbook = XLSX.read(data, { type: 'array' });
            const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            classList = jsonData.map(row => ({
                homeroom: row['HOMEROOM'] || '',
                fullName: (row['FULL NAME'] || '').trim()
            })).filter(s => s.fullName);
        }

        async function loadQuizData() {
            quizData = await fetchFromDatabase();
        }

        function analyzeData() {
            studentsNeedingLetters = classList.map(student => {
                // Find ALL attempts for this student
                const attempts = quizData.filter(q => 
                    q.student_name.toLowerCase().trim() === student.fullName.toLowerCase().trim()
                );

                // If no attempts at all
                if (attempts.length === 0) {
                    return { ...student, reason: 'Did not take quiz' };
                }

                // Find the best attempt (highest score among completed attempts)
                const completedAttempts = attempts.filter(a => a.completed);
                
                if (completedAttempts.length === 0) {
                    // Has attempts but none completed
                    return { ...student, reason: 'Did not complete' };
                }

                // Get the highest score from completed attempts
                const bestScore = Math.max(...completedAttempts.map(a => a.score));

                if (bestScore < 70) {
                    return { ...student, reason: `Best score: ${bestScore}%` };
                }

                // Student passed - no letter needed
                return null;
            }).filter(Boolean);

            document.getElementById('statsSection').style.display = 'grid';
            document.getElementById('totalStudents').textContent = classList.length;
            document.getElementById('completedStudents').textContent = classList.length - studentsNeedingLetters.length;
            document.getElementById('incompleteStudents').textContent = studentsNeedingLetters.length;

            if (studentsNeedingLetters.length > 0) {
                document.getElementById('studentListPreview').style.display = 'block';
                document.getElementById('studentListContent').innerHTML = studentsNeedingLetters
                    .map(s => `<div class="student-item"><span class="name">${s.fullName}</span><span class="reason">${s.reason}</span></div>`).join('');
            }
        }

        function updateTeacherName() {
            teacherName = document.getElementById('headerTeacherName').value.trim() || teacherName;
            localStorage.setItem('teacherName', teacherName);
        }

        function loadSavedTeacherName() {
            const saved = localStorage.getItem('teacherName');
            if (saved) { teacherName = saved; document.getElementById('headerTeacherName').value = saved; }
        }

        function loadSavedAssignment() {
            const saved = localStorage.getItem('assignmentName');
            if (saved) document.getElementById('assignmentName').value = saved;
        }

        async function generateAllPDFs() {
            if (!templateImage || studentsNeedingLetters.length === 0) {
                alert(studentsNeedingLetters.length === 0 ? 'ðŸŽ‰ All students completed!' : 'âŒ Letterhead not loaded');
                return;
            }

            const assignmentName = document.getElementById('assignmentName').value;
            localStorage.setItem('assignmentName', assignmentName);

            document.getElementById('loading').classList.add('show');
            document.getElementById('generateBtn').disabled = true;

            try {
                const zip = new JSZip();
                const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

                for (let student of studentsNeedingLetters) {
                    const pdf = generatePDFForStudent(student.fullName, assignmentName, today);
                    zip.file(`${student.fullName.replace(/\s+/g, '_')}.pdf`, pdf.output('blob'));
                }

                const content = await zip.generateAsync({ type: 'blob' });
                saveAs(content, `Incomplete_Homework_Letters_${new Date().toISOString().split('T')[0]}.zip`);
                alert(`âœ… Generated ${studentsNeedingLetters.length} PDFs!`);
            } catch (error) {
                alert('âŒ Error: ' + error.message);
            } finally {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('generateBtn').disabled = false;
            }
        }

        function generatePDFForStudent(studentName, assignmentName, today) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
            doc.addImage(templateImage, 'PNG', 0, 0, 297, 210);

            let yPos = templateSettings.contentY;
            const x = templateSettings.contentX, w = templateSettings.contentWidth, h = templateSettings.lineHeight;

            doc.setFontSize(11); doc.setFont(undefined, 'normal'); doc.setTextColor(0, 0, 0);
            doc.text(`Date: ${today}`, x, yPos); yPos += h * 2;
            doc.setFontSize(13); doc.setFont(undefined, 'bold');
            doc.text('Incomplete Homework', x, yPos); yPos += h * 2;
            doc.setFontSize(11); doc.setFont(undefined, 'normal');
            doc.text(`Dear Parent of ${studentName}`, x, yPos); yPos += h * 2;
            doc.text('Assalmu Aleikum', x, yPos); yPos += h * 2;

            const para1 = `Kindly be informed that your son has failed to complete the following tasks from his English Homework: ${assignmentName}`;
            doc.splitTextToSize(para1, w).forEach(line => { doc.text(line, x, yPos); yPos += h; }); yPos += h;

            const para2 = 'Please note that as a result, his Quarterly grades might be negatively affected.';
            doc.splitTextToSize(para2, w).forEach(line => { doc.text(line, x, yPos); yPos += h; }); yPos += h;

            const para3 = 'Kindly encourage your son to submit these tasks on ManageBac. If he fails to submit, the homework policy will apply.';
            doc.splitTextToSize(para3, w).forEach(line => { doc.text(line, x, yPos); yPos += h; }); yPos += h * 2;

            doc.text('Sincerely,', x, yPos); yPos += h * 2;
            doc.setFont(undefined, 'bold'); doc.text(teacherName, x, yPos);

            return doc;
        }
    </script>
</body>
</html>
